define(["require","jquery","components/modal"],function(t){"use strict";var e=t("jquery"),i=t("components/modal"),n=function(e,i,n){this.app=e;var o=this;t(["spotify-remote-control-bridge"],function(t){o.Spotify=t,o.bridge=new t.RemoteControlBridgeInterface,o.bridge.attach(i),o.bridge.attach(o.messageHandler.bind(o)),n()}),this.PLAYLIST_NAME="lastfm_persistent_player",this._clientConnectionTimeout=null};return n.prototype={FORCE_CLIENT_OPEN_DELAY:5e3,CHECK_CLIENT_OPENED_DELAY:2e3,play:function(t,e){this.bridge.playPauseTrack(t+(e?"#00:00":""),"track","spotify:trackset:"+this.PLAYLIST_NAME+":"+t)},pause:function(){this.bridge.pause()},messageHandler:function(t){("client-connected"==t.key||"client-connection-failed"==t.key)&&(this.cleanUpClientIframe(),clearTimeout(this._clientConnectionTimeout)),"client-connected"==t.key&&clearTimeout(this._clientSignUpConnectionTimeout)},connectSpotify:function(){this._clientConnectionTimeout=setTimeout(this.forceClientOpen.bind(this),n.prototype.FORCE_CLIENT_OPEN_DELAY),this.startBridge()},startBridge:function(){this.bridge.init({remoteBridgeUrl:"https://embed.spotify.com/remote-control-bridge/",targetOrigin:"https://embed.spotify.com"})},forceClientOpen:function(){this.openClient(),setTimeout(this.startBridge.bind(this),n.prototype.CHECK_CLIENT_OPENED_DELAY)},openClient:function(){var t=e('<iframe src="spotify://" style="display: none"></iframe>');t.addClass("open-spotify-client"),e("body").append(t)},cleanUpClientIframe:function(){var t=e(".open-spotify-client");t.remove()},getSpotify:function(){var t=this;this.app.eventMediator.publish("player.spotify.signup.start"),setTimeout(function(){var e=t.Spotify.Url.generate("embed.spotify.com/registration/",{creationFlow:"download",creationReferral:location.href,creationPoint:"last.fm",notifyBridge:!0,overlayMode:!0,partner_id:"lastfm",useWebPlayer:!1},"https:"),i=new t.Spotify.Popup({view:"iframe",size:[535,536],autoClose:!0,absolute:!1,id:"spotify-registration-module",iframeSrc:e,onHideCallback:function(){t.app.eventMediator.publish("player.spotify.signup.end")}});i.show()})},openSignup:function(t,o,r){var a=this;this.forceClientOpen(),this._clientSignUpConnectionTimeout=setTimeout(function(){var n={track:o.trackName,artist:o.artistName},s=function(){n.help=1;var o={replay:function(){i.close(),r()}};i.open(t+"?"+e.param(n),o)},p={getSpotify:function(){i.close(),a.getSpotify()},help:s},c=function(){a.app.eventMediator.publish("player.spotify.abort")};i.open(t+"?"+e.param(n),p,c)}.bind(this),n.prototype.FORCE_CLIENT_OPEN_DELAY)}},n});